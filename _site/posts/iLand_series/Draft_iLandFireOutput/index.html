<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.288">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-04-15">

<title>Katherine Hayes - Benchmarking Reburning in iLand</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Katherine Hayes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html" rel="" target="">
 <span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../cv.pdf" rel="" target="">
 <span class="menu-text">CV</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Benchmarking Reburning in iLand</h1>
            <p class="subtitle lead">Using terra to quantify overlaps in fire perimeter rasters</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Spatial Data Analysis</div>
                <div class="quarto-category">Benchmarking</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 15, 2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">May 22, 2024</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#what-are-the-patterns-of-reburning-in-iland" id="toc-what-are-the-patterns-of-reburning-in-iland" class="nav-link active" data-scroll-target="#what-are-the-patterns-of-reburning-in-iland">What are the patterns of reburning in iLand?</a></li>
  <li><a href="#fire-output-in-iland" id="toc-fire-output-in-iland" class="nav-link" data-scroll-target="#fire-output-in-iland">Fire output in iLand</a>
  <ul class="collapse">
  <li><a href="#determining-which-fires-in-iland-were-stand-replacing" id="toc-determining-which-fires-in-iland-were-stand-replacing" class="nav-link" data-scroll-target="#determining-which-fires-in-iland-were-stand-replacing">Determining which fires in iLand were stand-replacing</a></li>
  <li><a href="#saving-additional-fire-output" id="toc-saving-additional-fire-output" class="nav-link" data-scroll-target="#saving-additional-fire-output">Saving additional fire output</a></li>
  </ul></li>
  <li><a href="#a-quick-haha-aside-reburns" id="toc-a-quick-haha-aside-reburns" class="nav-link" data-scroll-target="#a-quick-haha-aside-reburns">A quick (haha) aside: Reburns</a>
  <ul class="collapse">
  <li><a href="#determining-overlap-between-rasters-using-the-terra-package" id="toc-determining-overlap-between-rasters-using-the-terra-package" class="nav-link" data-scroll-target="#determining-overlap-between-rasters-using-the-terra-package">Determining overlap between rasters using the <em>terra</em> package</a></li>
  <li><a href="#iland-reburn-trends" id="toc-iland-reburn-trends" class="nav-link" data-scroll-target="#iland-reburn-trends">iLand Reburn trends</a>
  <ul class="collapse">
  <li><a href="#comparing-iland-trends-to-mtbs-data" id="toc-comparing-iland-trends-to-mtbs-data" class="nav-link" data-scroll-target="#comparing-iland-trends-to-mtbs-data">Comparing iLand trends to MTBS data</a></li>
  </ul></li>
  <li><a href="#what-about-fire-severity" id="toc-what-about-fire-severity" class="nav-link" data-scroll-target="#what-about-fire-severity">What about fire severity?</a></li>
  </ul></li>
  <li><a href="#filtering-sapling-by-high-severity-fire" id="toc-filtering-sapling-by-high-severity-fire" class="nav-link" data-scroll-target="#filtering-sapling-by-high-severity-fire">Filtering sapling by high severity fire</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> smb://10.60.2.10/FF_Lab/personal_storage/kate_storage/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="what-are-the-patterns-of-reburning-in-iland" class="level1">
<h1>What are the patterns of reburning in iLand?</h1>
<p>As part of my <a href="https://www.nsf.gov/awardsearch/showAward?AWD_ID=2219248&amp;HistoricalAwards=false">NSF Postdoc fellowship</a>, I’ve been working on modeling herbivores in <a href="https://iland-model.org/iLand+Hub">iLand</a> using the biotic disturbance model <a href="https://iland-model.org/bite/#/">BITE</a>. In particular, I want to understand if biotic disturbances generally (and herbivores specifically) can interact with fire such that they modify forest composition or forest carbon at a landscape scale.</p>
<p>The following analysis started as an aside: I wanted to filter my simulation results to find modeled stands regenerating after fire so that I could compare age-growth relationships to those we wind in exclosure and other empirical studies of herbivory.</p>
</section>
<section id="fire-output-in-iland" class="level1 page-columns page-full">
<h1>Fire output in iLand</h1>
<section id="determining-which-fires-in-iland-were-stand-replacing" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="determining-which-fires-in-iland-were-stand-replacing">Determining which fires in iLand were stand-replacing</h2>
<p>First, I need to determine which fires in my iLand run were “stand-replacing” -</p>
<p>The fire output in iLand produces a table of each fire, shown below.</p>
<div class="cell tbl-cap-location-margin" data-tbl-cap="Base iLand Fire Output">

</div>
<p>There’s two ways to represent fire severity using this output: the <strong>proportion of trees killed</strong> within each fire, and the <strong>proportion of basal area killed</strong>. Those two metrics are distinct in slight yet important ways - a fire might kill all trees in a young stand but if the trees themselves were small, the impact on basal area won’t be terribly large. Or, a fire might kill only the largest/oldest individuals in a stand, thus impacting carbon greatly in a way that wouldn’t show up using just <strong>proportion of trees killed</strong>. Here, since we’re interested in how forests are regenerating, we’ll focus on instances where fires killed all trees, but I’ll show both for the sake of it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the fire years where there was no burn</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  fire <span class="ot">&lt;-</span> fire[fire<span class="sc">$</span>area_m2 <span class="sc">&gt;</span> <span class="dv">0</span>,] <span class="co"># no fire years with no burn</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>(<span class="fu">unique</span>(fire<span class="sc">$</span>fireId)) <span class="co"># how many fires occurred across the simulation?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  fire <span class="ot">&lt;-</span> fire <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>( <span class="co"># how many trees were killed?</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">prop.dens.killed =</span> n_trees_died <span class="sc">/</span> n_trees, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>            <span class="co"># what basal area was killed?</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">prop.ba.killed =</span> basalArea_died <span class="sc">/</span> basalArea_total) </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      fire<span class="sc">$</span>prop.ba.killed[fire<span class="sc">$</span>basalArea_total <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># set to 0</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      fire<span class="sc">$</span>prop.dens.killed[fire<span class="sc">$</span>n_trees <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, there’s one challenge with this:</p>
<div class="cell caption-margin">

</div>
<div class="cell caption-margin">

</div>
<p>You’ll notice neither metric shows values that are completely equal to 100%. At first this seems like a problem, right?<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;none of our fires were stand-replacing??</p></li></div><p>This is an important nuance of the iLand fire output - <strong>n_trees_killed</strong> and <strong>basalArea_died</strong> are aggregated across the entire fire. Cells within the fire may have experienced full canopy mortality, but since we’re working with averages, it’ll be very very rare (if not impossible) for a stand to have 100% of stems killed across the entire fire.</p>
</section>
<section id="saving-additional-fire-output" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="saving-additional-fire-output">Saving additional fire output</h2>
<p>We’ll need more detail, and thankfully there’s a fun way to solve this - by adding a javascript file to the <strong>scripts</strong> folder, you can add code that tells iLand to save raster files of the perimeter of each fire with additional information. Some options of things to turn on include:</p>
<ul>
<li><strong>crownKill</strong>: fraction of the crown killed within a burned resource unit (see <a href="https://iland-model.org/wildfire" title="fire disturbance modeling">wildfire</a> ).</li>
<li><strong>diedStemsFrac</strong>: fraction of killed trees within a burned resource unit</li>
<li><strong>diedBasalArea</strong>: basal area (sum over resource units) of burnt trees.</li>
<li><strong>KBDI</strong>: Keetch Byram Drought Index (see <a href="https://iland-model.org/wildfire" title="fire disturbance modeling">wildfire</a> ).</li>
<li><strong>baseIgnition</strong>: base probability of an annual fire ignition event for a cell on RU level (depending on fire-return-interval and average fire size)</li>
<li><strong>fuel</strong>: burned fuel (forest floor + dwd) kg/ha</li>
<li><strong>combustibleFuel</strong>: “available combustible fuel (current KBDI, forest floor + dwd) kg/ha</li>
<li><strong>nFire</strong>: cumulative count of fire events on a resource unit<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li>
<li><strong>lastFireYear</strong>: simulation year of the last fire event on a RU</li>
</ul>
<div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;Breaking the forth wall: discovered this output while putting together this quarto document. In future runs, I’ll turn this on and avoid some of the steps described later in the document to filter out reburns</p></li><li id="fn3"><p><sup>3</sup>&nbsp;Note that this is trees killed within burned resource units, not saplings. It still works for our purposes for a few reasons:</p>
<ol type="1">
<li>The likelihood that saplings survive in a burned resource unit where all trees are killed seems low (but we can go ahead and check later on)</li>
<li>Since I’m interested in height-growth relationships, I’ll be filtering out saplings with ages older than the time since fire for the resource unit, so we should catch any that slip through (again, even if they do)</li>
</ol>
</li></div><p>For this analysis, we’ll stick to <strong>diedStemsFrac</strong> - the number of trees killed within a resource unit<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. First, you need to add a function into your iLand model to tell it to save the extra output.</p>
<p>The code to do so is the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">afterFireProcessing</span>() {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">var</span> praefix <span class="op">=</span> Globals<span class="op">.</span><span class="at">year</span><span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">var</span> pid<span class="op">=</span> Fire<span class="op">.</span><span class="at">id</span><span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">// save the form of the fire in ESRI raster format</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">// save a file for each fire</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>   Fire<span class="op">.</span><span class="fu">grid</span>(<span class="st">"diedStemsFrac"</span>)<span class="op">.</span><span class="fu">save</span>(<span class="st">'output/dead/dead_'</span><span class="op">+</span> pid <span class="op">+</span><span class="st">'.txt'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Add this in to a javascript file within the <strong>Scripts</strong> folder in your iLand folder ecosystem, and enable &lt;management&gt; under &lt;/model&gt; in your project file. Now, if you set up a <strong>“dead”</strong> folder in your output, a raster of values of stems killed will save after each fire.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="no-row-height column-margin column-container"><li id="fn4"><p><sup>4</sup>&nbsp;To track other items from the list of variables above, call a new Fire.grid() within the afterFireProcessing function and give it a unique save destination</p></li></div><p>In order to filter our sapling output by the cells that experienced canopy-replacing fire, we can filter not only by the rasters (the footprint of the fire), but by the value of <strong>diedStemsFraction</strong> variable within each raster pixel (which represent resource units in the iLand landscape).</p>
<p>Then, load the fire perimeters into R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stacking fire spread files</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>      path <span class="ot">=</span> <span class="st">"D:/workspace/Kate/iland/model/output/dead/snapshot42"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>      fire_maps <span class="ot">=</span> <span class="fu">rast</span>(<span class="fu">list.files</span>(path, <span class="at">full.names =</span> T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <strong>rast()</strong> from the <em>terra</em> package <span class="citation" data-cites="terra">(<a href="#ref-terra" role="doc-biblioref">Hijmans 2023</a>)</span> creates a <strong>SpatRaster</strong> object, a object type in R that can represent multi-layer or multi-variable raster data. Here, the object <strong>fire_maps</strong> we just created is a three-dimensional raster - the first two dimensions are the x and y axis of our iLand landscape and the third dimension is 27 layers of fire perimeters (one for each fire within the simulation). Each pixel within that raster represents an individual resource unit from the iLand landscape and contains a value from 0 -1, representing <strong>diedStemsFrac.</strong></p>
<div class="no-row-height column-margin column-container"><div id="ref-terra" class="csl-entry" role="listitem">
Hijmans, Robert J. 2023. <span>“Terra: Spatial Data Analysis.”</span> <a href="https://CRAN.R-project.org/package=terra">https://CRAN.R-project.org/package=terra</a>.
</div></div><div class="cell tbl-cap-location-margin" data-tbl-cap="Values of fire_maps SpatRaster">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fire_maps </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nlyr</span>(fire_maps) <span class="co"># 27 layers, one for each fire</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(<span class="fu">values</span>(fire_maps)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can call on each of those 27 layers to examine the fire perimeters one by one. For example, this is the fire perimeter from the first fire in the simulation:</p>
<div class="cell caption-margin">

</div>
<p>We’ll use these rasters to determine which resource units experienced stand-replacing fire<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>, and use those resource unit IDs to filter the sapling and tree data.</p>
<div class="no-row-height column-margin column-container"><li id="fn5"><p><sup>5</sup>&nbsp;Which we can now define more specifically as <strong>diedStemFrac</strong> = 1</p></li></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>An aside: this run is a spin-up simulation - I ran iLand, initializing forests from an empty landscape<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> in year 0, and simulated forest growth and fire over 300 years. This seems to be the sweet spot for simulation runs - at year 300, we have a landscape full of a mix of mature, regenerating and recently burned stands, just as we’d observe in real life. Since fires that occur early in the spin-up inherently burn young stands, it’s not terribly representative of the relationship between height and age in regrowth that we want to eventually compare to the herbivore-impacted relationship. So, we’ll filter to just the last 100 years of the simulation.</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><li id="fn6"><p><sup>6</sup>&nbsp;An aside to the aside (meta!!) - it’s an empty landscape in the sense that there are no trees in year 0, but we do initialize using a soil organic layer that varies heterogeneously across the landscape. This isn’t just to represent real life for real life’s sake - initializing from truly empty (truly bare ground) causes totally different patterns of forests. As has been shown in decades of work in Alaska by Jill Johnstone and others, soil organic layer filters forest community composition in really critical ways, allowing spruce to outcompete species like birch and aspen which can’t persist in thick soil or moss layers for as long.</p></li></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Question: what determines the initial heterogeneity in the SOL when initiating from bare ground using the permafrost module? (technically it’s the moss layer heterogeneity in year 0 that introduces the SOL heterogeneity in year 1 - where do those initial values come from?)</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filtering to last 100 years of fire</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  fire100 <span class="ot">&lt;-</span> fire <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">&gt;</span><span class="dv">200</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>(<span class="fu">unique</span>(fire100<span class="sc">$</span>fireId)) <span class="co"># How many fires in the last 100 years?</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dropping layers from fire raster</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  fire_maps100 <span class="ot">&lt;-</span> <span class="fu">subset</span>(fire_maps, </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">paste0</span>(<span class="st">"dead_"</span>, fire100<span class="sc">$</span>fireId))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="a-quick-haha-aside-reburns" class="level1 page-columns page-full">
<h1>A quick (haha) aside: Reburns</h1>

<div class="no-row-height column-margin column-container"><div class="">
<p>you can take the girl out of the Reburn PhD, but you can’t take the Reburn PhD out of the girl</p>
</div><li id="fn7"><p><sup>7</sup>&nbsp;Particularly since the historic fire return interval for this system was somewhere between 100-300 years <span class="citation" data-cites="kelly2013">(<a href="#ref-kelly2013" role="doc-biblioref"><strong>kelly2013?</strong></a>)</span></p></li></div><p>Even within the relatively narrow window of 100 years<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>, reburning occurs within the model! Here’s the footprint of all fires in the last 100 years of the spin up - you can see there’s some considerable overlap, or reburning.</p>
<div class="cell caption-margin">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># setting background to NA to make transparent</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  fire_mapsNA <span class="ot">&lt;-</span> <span class="fu">subst</span>(fire_maps100, <span class="dv">0</span>, <span class="cn">NA</span>) <span class="co"># need to do this anyways but now it'll let us stack</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_18"</span>])</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_19"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_20"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_21"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_22"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_23"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_24"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_25"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_26"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsNA[<span class="st">"dead_27"</span>], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="determining-overlap-between-rasters-using-the-terra-package" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="determining-overlap-between-rasters-using-the-terra-package">Determining overlap between rasters using the <em>terra</em> package</h2>
<p>Since for this analysis we’re interested in the relationship between height and age, we’ll need to filter out stands that burned shortly<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> after preceding fires - a disturbance pattern which would definitely impact age-height relationships. We’ll need to figure out where the overlaps actually occur, so we can exclude the corresponding resource units from the sapling and tree data later. I’ll do this process in two ways: 1) by looking at the physical overlap between the entirety of the fire perimeters, 2) by looking only at the overlap between high severity fires.</p>
<div class="no-row-height column-margin column-container"><li id="fn8"><p><sup>8</sup>&nbsp;Typically, “short-interval” fire in the boreal is defined as 50 years or less between fires <span class="citation" data-cites="buma2022">(<a href="#ref-buma2022" role="doc-biblioref">Buma et al. 2022</a>)</span>. Since I’m looking across a window of 100 years, I’m assuming everything that reburns in that 100 years is “short-interval” - I haven’t looked to see if there’s resource units that burn in year 1 and reburn in year 99, and maybe I’ll do that down the line, but right now I don’t want to bother.</p><div id="ref-buma2022" class="csl-entry" role="listitem">
Buma, B., K. Hayes, S. Weiss, and M. Lucash. 2022. <span>“Short-Interval Fires Increasing in the Alaskan Boreal Forest as Fire Self-Regulation Decays Across Forest Types.”</span> <em>Scientific Reports</em> 12 (1): 4901. <a href="https://doi.org/10.1038/s41598-022-08912-8">https://doi.org/10.1038/s41598-022-08912-8</a>.
</div></li></div><p>The <strong>intersect()</strong> function in <em>terra</em> is useful for checking overlap, but only takes two rasters at a time:</p>
<div class="cell caption-margin">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>overlap <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">intersect</span>(fire_mapsNA[[<span class="st">"dead_18"</span>]],</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                            fire_mapsNA[[<span class="st">"dead_19"</span>]])</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(overlap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Turns out, the best way I’ve found to quickly check which rasters overlap actually involves <em>terra</em>’s <strong>mosaic()</strong> function:</p>
<div class="cell caption-margin">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># split all the layers into a list</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mapList <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">split</span>(fire_mapsNA, <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(fire_mapsNA))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># turn list into SpatRaster Collection</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>mapSPC <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">sprc</span>(mapList) </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># merge values across layers</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>reburn <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">mosaic</span>(mapSPC, <span class="at">fun =</span> <span class="st">"sum"</span>) <span class="co"># can apply a number of functions (mean, etc)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(reburn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Yay!! Okay!! Now, if we set all the values of the layers to 1, we’ll end up with a raster of number of fires.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>perim <span class="ot">&lt;-</span> fire_maps100 <span class="sc">&gt;</span> <span class="dv">0</span> <span class="co"># exclude unburned values</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># setting all values to 1 regardless of diedStemFrac</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>perim <span class="ot">&lt;-</span> <span class="fu">subst</span>(perim, <span class="cn">TRUE</span>, <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>) <span class="co"># everything else NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell caption-margin">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># split all the layers into a list</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>perimList <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">split</span>(perim, <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(perim))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># turn list into SpatRaster Collection</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>perimSPC <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">sprc</span>(perimList) </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># merge values across layers</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>nFire <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">mosaic</span>(perimSPC, <span class="at">fun =</span> <span class="st">"sum"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nFire)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>yay!! Now we can filter by the value of <strong>nFire</strong> to get the specific resource units that burned and eventually exclude them for the analysis.</p>
</section>
<section id="iland-reburn-trends" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="iland-reburn-trends">iLand Reburn trends</h2>
<p>A few more exploratory tangential questions since we’re here:</p>
<p>How much of the landscape burned once?</p>
<div class="cell caption-margin">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>nfire1 <span class="ot">&lt;-</span> <span class="fu">subst</span>(nFire, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nfire1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># also bring in the environment grid </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we'll use this to get ids for each grid</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>      env.grid <span class="ot">=</span> <span class="fu">rast</span>(<span class="st">"D:/workspace/Kate/iland/materials/env/env.grid.tif"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># what RID burned once?</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>nfire1rid <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mask</span>(env.grid, nfire1))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># how many unique resource units are there?</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>domain <span class="ot">&lt;-</span> <span class="fu">ncell</span>(env.grid) <span class="co"># dimensions are 239 by 255 </span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># how many resource units burned once?</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(nfire1rid<span class="sc">$</span>env.grid)) </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># so, what %?</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>((<span class="fu">length</span>(<span class="fu">unique</span>(nfire1rid<span class="sc">$</span>env.grid)) <span class="sc">/</span> domain) <span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How much burned twice?</p>
<div class="cell caption-margin">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>nfire2 <span class="ot">&lt;-</span> <span class="fu">subst</span>(nFire, <span class="dv">2</span>, <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nfire2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># what RID burned twice?</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>nfire2rid <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mask</span>(env.grid, nfire2))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># so, what %?</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>((<span class="fu">length</span>(<span class="fu">unique</span>(nfire2rid<span class="sc">$</span>env.grid)) <span class="sc">/</span> domain) <span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How much burned three times?</p>
<div class="cell caption-margin">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>nfire3 <span class="ot">&lt;-</span> <span class="fu">subst</span>(nFire, <span class="dv">3</span>, <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nfire3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># what RID burned thrice?</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>nfire3rid <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mask</span>(env.grid, nfire3))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># so, what %?</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>((<span class="fu">length</span>(<span class="fu">unique</span>(nfire3rid<span class="sc">$</span>env.grid)) <span class="sc">/</span> domain) <span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="comparing-iland-trends-to-mtbs-data" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="comparing-iland-trends-to-mtbs-data">Comparing iLand trends to MTBS data</h3>
<p>How does that compare to what we see in the real life frequency of reburning? As part of my work with reburns during my PhD, I worked on a paper with Brian Buma, Melissa Lucash and Shelby Weiss where we looked at trends in reburning across Alaska using the Monitoring Trends in Burn Severity database (MTBS) <span class="citation" data-cites="buma2022">(<a href="#ref-buma2022" role="doc-biblioref">Buma et al. 2022</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div><p>A few important differences to cover up front:</p>
<ul>
<li><a href="https://www.mtbs.gov/">MTBS</a> data for Alaska covers 1984 to 2016 - so, the data captures a 32 year window instead of a 100 year one.</li>
<li>We used a threshold of 2 to categorize MTBS maps of burn severity into “burned” and “unburned” classifications. I don’t remember if we tested the sensitivity of our analysis to that threshold - I’m super curious how those percentages would change if we filtered to just the cells marked as high severity by MTBS.</li>
<li>I don’t remember off the top of my head how we dealt with Ecoregion / what Ecoregion CPCRW would fall into.</li>
</ul>
<div id="tbl-MTBS-reburns" class="cell tbl-cap-location-margin tbl-parent anchored" data-tbl-cap="Reburn Frequency of MTBS data from 1984 - 2016, across ecoregion (Buma et al. ">
<p><strong>?(caption)</strong></p>
</div>
<p>Again, the reburn frequency in the 100 year interval of iLand is the following:</p>
<div id="tbl-iLand-reburns" class="cell tbl-cap-location-margin tbl-parent anchored" data-tbl-cap="iLand Reburn Frequency ">
<p><strong>?(caption)</strong></p>
</div>
<p>So, lower percentages than we see in the MTBS data.</p>
<p>An obviously incomplete spitball list of reasons reburning could be lower in iLand:</p>
<ul>
<li><p><strong>iLand is super stochastic?</strong> - runs vary from simulation to simulation. I can try replicating this simulation a few hundred times and averaging fire frequency across them all to see if the distribution of reburning becomes more similar to what we observe in MTBS</p></li>
<li><p><strong>Uncertainty in MTBS?</strong></p></li>
<li><p><strong>Mechanisms that drive fire in iLand underestimate reburning?</strong></p></li>
</ul>
</section>
</section>
<section id="what-about-fire-severity" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-about-fire-severity">What about fire severity?</h2>
<p>Now, we can introduce one more layer: in theory, we<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> often expect reburns (or fires that burn into existing fire perimeters) to occur at diminishing severity. Depending on the window between fires, fuel availability may limit combustion in reburns. Based on that logic, are there overlaps between stands that burned at high severity?</p>
<div class="no-row-height column-margin column-container"><li id="fn9"><p><sup>9</sup>&nbsp;we, the royal fire ecologists</p></li></div><div class="cell caption-margin">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter to just stands with high severity</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cells with diedStemsFrac = 1</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  fire_mapsHS <span class="ot">&lt;-</span> <span class="fu">subst</span>(fire_maps100, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_18"</span>]])</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_19"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_20"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_21"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_22"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_23"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_24"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_25"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_26"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fire_mapsHS[[<span class="st">"dead_27"</span>]], <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Obviously less area there. Is there any overlap?</p>
<div class="cell" data-fig-cap-location="margin">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># split all the layers into a list</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>hsList <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">split</span>(fire_mapsHS, <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(fire_mapsHS))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># turn list into SpatRaster Collection</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>hsSPC <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">sprc</span>(hsList) </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># merge values across layers</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>nFireHS <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">mosaic</span>(hsSPC, <span class="at">fun =</span> <span class="st">"sum"</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nFireHS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Okay. Pretty sparse, but technically there’s still resource units that burned completely both times.</p>
<div class="cell" data-fig-cap-location="margin">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>nfireHS2 <span class="ot">&lt;-</span> <span class="fu">subst</span>(nFireHS, <span class="dv">2</span>, <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nfireHS2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># what RID burned twice at HS?</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>nfireHS2rid <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mask</span>(env.grid, nfireHS2))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># how many resource units?</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(nfireHS2rid<span class="sc">$</span>env.grid))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># so, what %?</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>(<span class="fu">length</span>(<span class="fu">unique</span>(nfireHS2rid<span class="sc">$</span>env.grid)) <span class="sc">/</span> domain) <span class="sc">*</span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’m curious about the years that burned twice at high severity. What’s the interval between them?</p>
<p>To get back to years, we’ll have to use the list of RIDs to find <em>fireID</em> in the <strong>fire_maps</strong> object, and then use <em>fireID</em> to look in the original fire output from iLand. Essentially, retracing our steps. I’ll start by converting the object containing resource units that burned twice at high severity (<strong>nfireHS2</strong>) back to a polygon, so I can use <em>terra</em>’s <strong>extract()</strong> function to pull information from fire_maps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>nfireHS2poly <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">as.polygons</span>(nfireHS2)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nfireHS2poly)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>fire_mapsHS2 <span class="ot">&lt;-</span> <span class="fu">extract</span>(fire_maps100, nfireHS2poly)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fire_mapsHS2)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># drop ID column</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>fire_mapsHS2 <span class="ot">&lt;-</span> fire_mapsHS2 <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span>ID) <span class="sc">%&gt;%</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="fu">any</span>(. <span class="sc">!=</span> <span class="dv">0</span>)))</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(fire_mapsHS2)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 18 reburned 19</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 18 reburned 20</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 23 reburned 27</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 25 reburned 27</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>fireHS2 <span class="ot">&lt;-</span>  fire <span class="sc">%&gt;%</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(year, fireId)) <span class="sc">%&gt;%</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fireId <span class="sc">%in%</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(<span class="fu">colnames</span>(fire_mapsHS2), <span class="sc">-</span><span class="dv">2</span>))) </span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>fireHS2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="filtering-sapling-by-high-severity-fire" class="level1">
<h1>Filtering sapling by high severity fire</h1>
<p>Now, we want to use the row id numbers from the <strong>fire_mapsHS</strong> object to filter out rows in the <strong>sapling</strong> and <strong>stand</strong> output that burned at high severity. The following code loops through each of the fire maps, extracting the resource unit ID numbers, the fire ID and the fire year (which come from the default fire output) and compiling into a dataframe, <strong>fireID</strong>. What fraction of the landscape burned at high severity? (ie, how many resource units?)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how many unique resource units are there?</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>domain <span class="ot">&lt;-</span> <span class="fu">ncell</span>(env.grid) <span class="co"># dimensions are 239 by 255 </span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># how many resource units burned at HS?</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(fireID<span class="sc">$</span>rid)) </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># so, what %?</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>(<span class="fu">length</span>(<span class="fu">unique</span>(fireID<span class="sc">$</span>rid)) <span class="sc">/</span> domain) <span class="sc">*</span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, only about 1% of the landscape burned at high severity across the 100 year simulation window. (Though, technically that would be an underestimate since it doesn’t take into account the resource units that reburned).</p>
</section>
<section id="session-info" class="level1">
<h1>Session Info</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.3 (2024-02-29)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Sonoma 14.0

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] kableExtra_1.4.0 cowplot_1.1.3    terra_1.7-55     lubridate_1.9.3 
 [5] forcats_1.0.0    stringr_1.5.1    dplyr_1.1.4      purrr_1.0.2     
 [9] readr_2.1.5      tidyr_1.3.1      tibble_3.2.1     ggplot2_3.5.0   
[13] tidyverse_2.0.0 

loaded via a namespace (and not attached):
 [1] utf8_1.2.4        generics_0.1.3    xml2_1.3.6        stringi_1.8.3    
 [5] hms_1.1.3         digest_0.6.35     magrittr_2.0.3    evaluate_0.23    
 [9] grid_4.3.3        timechange_0.3.0  fastmap_1.1.1     jsonlite_1.8.8   
[13] fansi_1.0.6       viridisLite_0.4.2 scales_1.3.0      codetools_0.2-19 
[17] cli_3.6.2         rlang_1.1.3       munsell_0.5.0     withr_3.0.0      
[21] yaml_2.3.8        tools_4.3.3       tzdb_0.4.0        colorspace_2.1-0 
[25] vctrs_0.6.5       R6_2.5.1          lifecycle_1.0.4   htmlwidgets_1.6.4
[29] pkgconfig_2.0.3   pillar_1.9.0      gtable_0.3.4      glue_1.7.0       
[33] Rcpp_1.0.12       systemfonts_1.0.6 xfun_0.43         tidyselect_1.2.1 
[37] rstudioapi_0.16.0 knitr_1.45        htmltools_0.5.8   rmarkdown_2.26   
[41] svglite_2.1.3     compiler_4.3.3   </code></pre>
</div>
</div>



</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="k8hayes/BlogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>