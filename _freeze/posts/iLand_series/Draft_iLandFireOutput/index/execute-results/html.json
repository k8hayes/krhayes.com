{
  "hash": "526eb37ef4fc87991b2960f9f3c0052e",
  "result": {
    "markdown": "---\ntitle: Benchmarking Reburning in iLand\ndescription: Using terra to quantify overlaps in fire perimeter rasters\nsubtitle: Part One in a Series on iLand benchmarking\ndate: 2024-05-28\ncategories: [Spatial Data Analysis, iLand, Benchmarking]\ndate-modified: last-modified\nbibliography: references.bib\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n# What are the patterns of reburning in iLand?\n\nAs part of my [NSF Postdoc fellowship](https://www.nsf.gov/awardsearch/showAward?AWD_ID=2219248&HistoricalAwards=false), I've been working on modeling herbivores in [iLand](https://iland-model.org/iLand+Hub) using the biotic disturbance model [BITE](https://iland-model.org/bite/#/). In particular, I want to understand if biotic disturbances generally (and herbivores specifically) can interact with fire such that they modify forest composition or forest carbon at a landscape scale.\n\nThe following analysis started as an aside: I wanted to filter my simulation results to find modeled stands regenerating after fire so that I could compare age-growth relationships to those found in exclosure and other empirical studies of herbivory.\n\n# Fire output in iLand\n\n## Determining which fires in iLand were stand-replacing\n\nFirst, I need to determine which fires in my iLand run were \"stand-replacing\" -\n\nThe fire output in iLand produces a table of each fire, shown below.\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n| year| fireId| area_plan_m2|   area_m2| iterations| coord_x| coord_y|  n_trees| n_trees_died| basalArea_total| basalArea_died| psme_died| avgFuel_kg_ha| windSpeed| windDirection|\n|----:|------:|------------:|---------:|----------:|-------:|-------:|--------:|------------:|---------------:|--------------:|---------:|-------------:|---------:|-------------:|\n|    6|      1|      9355921|   9359200|         95|    7390|    8810|  1106699|      1064982|       2388.6883|       2298.610|         0|      39755.37|  17.67204|      187.2722|\n|   11|      2|     10613320|  10667600|        105|   18030|   23030|   535890|       514951|       2157.1445|       2067.686|         0|      55101.33|  16.16441|      254.2023|\n|   18|      3|     66038024|  66571200|        256|   20110|   11130|  9971141|      8522890|      62771.2287|      53269.425|         0|      43763.40|  12.09752|      197.0730|\n|   37|      4|     13235234|  13236000|        105|   16010|    8770|  1722762|      1362931|      15451.4867|      11253.633|         0|      40959.27|  23.64123|      268.0712|\n|   49|      5|     62118545|  62408800|        249|    7630|    2990|  6223445|      4654781|      82294.3472|      55315.312|         0|      45441.38|  23.28553|      235.8422|\n|   79|      6|    153096650| 153714800|        383|    4110|   14530| 13023363|      9126662|     219533.7647|     126019.528|         0|      43652.15|  13.33987|      254.2933|\n|   93|      7|      1258524|   1277600|         34|   22990|   13390|   141322|        99230|       2471.1608|       1493.027|         0|      29401.03|  11.58742|      200.6049|\n|  101|      8|     17526161|  17739600|        129|    1450|   14410|   517573|       397160|       6548.2361|       2715.915|         0|      32069.33|  27.12384|      260.0029|\n|  113|      9|     23251611|  23413600|        151|   15850|    6210|  1705366|      1193239|      34838.5227|      19189.206|         0|      42169.49|  25.58756|      233.4567|\n|  115|     10|      1981966|   2008400|         39|    1210|   13970|    66117|        50832|        683.4222|        229.551|         0|      16211.83|  15.73365|      239.5789|\n|  127|     11|     24433818|  24488400|        151|    1970|   19310|  1130352|       896409|      15474.3118|       8279.242|         0|      51011.59|  13.86956|      257.5287|\n|  128|     12|      3461822|   3543600|         60|    6130|    6090|   520249|       365378|       7815.2903|       4422.803|         0|      19316.17|  18.26541|      228.5157|\n|  155|     13|     42209881|  42216000|        242|     530|   14930|  3168223|      2320287|      51250.5543|      23932.379|         0|      38331.30|  24.37498|      207.2945|\n|  170|     14|     30183070|  30241600|        158|    5810|   20370|  1348460|      1133645|      19465.7227|      11652.611|         0|      55874.93|  15.20795|      216.0514|\n|  186|     15|      3774943|   3904400|         56|    4230|    7330|   280457|       190965|       5742.5958|       2823.583|         0|      36889.62|  16.33519|      263.5800|\n|  186|     16|     14987103|  15212000|        109|    4130|   13010|  1636544|      1228222|      23955.1826|       9779.148|         0|      24929.67|  29.18820|      191.5560|\n|  192|     17|      6080132|   6218400|         75|   19730|    3030|   556809|       391779|      11443.7747|       5326.691|         0|      29748.50|  12.43170|      240.7054|\n|  196|     18|     82774479|  82817600|        279|    8770|    5230|  6073521|      4301367|     126098.1813|      62908.374|         0|      35699.13|  13.31725|      183.1845|\n|  205|     19|     42031808|  42087200|        211|    7830|   22150|  1186354|       971450|      18140.2053|       8789.391|         0|      54178.54|  24.14464|      190.5515|\n|  206|     20|      4759821|   4852800|         72|   14530|   14770|   292863|       223986|       5391.1960|       2530.305|         0|      40919.96|  22.24638|      188.9378|\n|  209|     21|     27161911|  27330000|        161|   10550|    7650|  2228298|      1700506|      24846.2545|      11125.712|         0|      22243.74|  11.80762|      219.2560|\n|  229|     22|     86507214|  86949600|        319|    1650|    7350|  8545906|      6381659|     114956.2688|      54858.865|         0|      35720.83|  24.34829|      214.7623|\n|  255|     23|      6448735|   6564000|         73|   21630|   10610|   407364|       325927|       6143.1676|       2588.093|         0|      38903.49|  11.11992|      232.8224|\n|  273|     24|     74646095|  74958000|        259|    6330|    5730|  9639587|      7044859|     129629.1524|      70688.719|         0|      29775.69|  11.04457|      205.9398|\n|  288|     25|     12147746|  12311200|        111|   14110|    4930|   691252|       496647|      14124.9318|       5887.714|         0|      42145.70|  17.91752|      257.8751|\n|  290|     26|     61986520|  62263200|        235|    6130|    7250| 13305606|     10319713|      92403.2798|      47632.022|         0|      16508.43|  27.38842|      235.8599|\n|  291|     27|      6288371|   6466800|         81|   21630|    7530|   417439|       322173|       6507.2185|       2719.114|         0|      40083.61|  25.11454|      264.0305|\n\n\n:::\n:::\n\n\nThere's two ways to represent fire severity using this output: the **proportion of trees killed** within each fire, and the **proportion of basal area killed**. Those two metrics are distinct in slight yet important ways - a fire might kill all trees in a young stand but if the trees themselves were small, the impact on basal area won't be terribly large. Or, a fire might kill only the largest/oldest individuals in a stand, thus impacting carbon greatly in a way that wouldn't show up using just **proportion of trees killed**. Here, since we're interested in how forests are regenerating, I'll focus on instances where fires killed all trees, but I'll show both for the sake of it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# drop the fire years where there was no burn\n  fire <- fire[fire$area_m2 > 0,] # no fire years with no burn\n  length(unique(fire$fireId)) # how many fires occurred across the simulation?\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 27\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n  fire <- fire %>% \n    mutate( # how many trees were killed?\n              prop.dens.killed = n_trees_died / n_trees, \n            # what basal area was killed?\n              prop.ba.killed = basalArea_died / basalArea_total) \n      \n      fire$prop.ba.killed[fire$basalArea_total == 0] <- 0 # set to 0\n      fire$prop.dens.killed[fire$n_trees == 0] <- 0\n```\n:::\n\n\nHowever, there's one challenge with this. Here's the percent of stems killed across fires:\n\n\n::: {.cell .caption-margin}\n::: {.cell-output-display}\n![Percent of stems killed across fires](index_files/figure-html/fig-stems-killed-1.png){#fig-stems-killed width=672}\n:::\n:::\n\n\nAnd here's the percent basal area killed across all fires:\n\n\n::: {.cell .caption-margin}\n::: {.cell-output-display}\n![Percent basal area killed across fires](index_files/figure-html/fig-ba-killed-1.png){#fig-ba-killed width=672}\n:::\n:::\n\n\nYou'll notice neither metric shows values that are completely equal to 100%. At first this seems like a problem, right?[^1]\n\n[^1]: none of our fires were stand-replacing??\n\nThis is an important nuance of the iLand fire output - **n_trees_killed** and **basalArea_died** are aggregated across the entire fire. Cells within the fire may have experienced full canopy mortality, but since we're working with averages, it'll be very very rare (if not impossible) for a stand to have 100% of stems killed across the entire fire.\n\n## Saving additional fire output\n\nI'll need more detail, and thankfully there's a fun way to solve this - by adding a javascript file to the **scripts** folder, you can add code that tells iLand to save raster files of the perimeter of each fire with additional information. Some options of things to turn on include:\n\n-   **crownKill**: fraction of the crown killed within a burned resource unit (see [wildfire](https://iland-model.org/wildfire \"fire disturbance modeling\") ).\n-   **diedStemsFrac**: fraction of killed trees within a burned resource unit\n-   **diedBasalArea**: basal area (sum over resource units) of burnt trees.\n-   **KBDI**: Keetch Byram Drought Index (see [wildfire](https://iland-model.org/wildfire \"fire disturbance modeling\") ).\n-   **baseIgnition**: base probability of an annual fire ignition event for a cell on RU level (depending on fire-return-interval and average fire size)\n-   **fuel**: burned fuel (forest floor + dwd) kg/ha\n-   **combustibleFuel**: \"available combustible fuel (current KBDI, forest floor + dwd) kg/ha\n-   **nFire**: cumulative count of fire events on a resource unit[^2]\n-   **lastFireYear**: simulation year of the last fire event on a RU\n\n[^2]: Breaking the forth wall: discovered this output while putting together this quarto document. In future runs, I'll turn this on and avoid some of the steps described later in the document to filter out reburns\n\nFor this analysis, I'll stick to **diedStemsFrac** - the number of trees killed within a resource unit[^3]. First, you need to add a function into your iLand model to tell it to save the extra output.\n\n[^3]: Note that this is trees killed within burned resource units, not saplings. It still works for our purposes for a few reasons:\n\n    1.  The likelihood that saplings survive in a burned resource unit where all trees are killed seems low (but I can go ahead and check later on)\n    2.  Since I'm interested in height-growth relationships, I'll be filtering out saplings with ages older than the time since fire for the resource unit, so I should catch any that slip through (again, even if they do)\n\nThe code to do so is the following:\n\n\n::: {.cell}\n\n```{.js .cell-code}\nfunction afterFireProcessing() {\n   var praefix = Globals.year;\n   var pid= Fire.id;\n   // save the form of the fire in ESRI raster format\n   // save a file for each fire\n   Fire.grid(\"diedStemsFrac\").save('output/dead/dead_'+ pid +'.txt')\n}\n```\n:::\n\n\nAdd this in to a javascript file within the **Scripts** folder in your iLand folder ecosystem, and enable \\<management\\> under \\</model\\> in your project file. Now, if you set up a **\"dead\"** folder in your output, a raster of values of stems killed will save after each fire.[^4]\n\n[^4]: To track other items from the list of variables above, call a new Fire.grid() within the afterFireProcessing function and give it a unique save destination\n\nIn order to filter our sapling output by the cells that experienced canopy-replacing fire, I can filter not only by the rasters (the footprint of the fire), but by the value of **diedStemsFraction** variable within each raster pixel (which represent resource units in the iLand landscape).\n\nThe function **rast()** from the *terra* package [@terra] creates a **SpatRaster** object, a object type in R that can represent multi-layer or multi-variable raster data. Here, the object **fire_maps** is a three-dimensional raster - the first two dimensions are the x and y axis of our iLand landscape and the third dimension is 27 layers of fire perimeters (one for each fire within the simulation). Each pixel within that raster represents an individual resource unit from the iLand landscape and contains a value from 0 -1, representing **diedStemsFrac.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_maps \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 239, 255, 27  (nrow, ncol, nlyr)\nresolution  : 100, 100  (x, y)\nextent      : 462504.2, 488004.2, 7215242, 7239142  (xmin, xmax, ymin, ymax)\ncoord. ref. :  \nsource      : fire_maps.tif \nnames       : dead_1, dead_10, dead_11, dead_12, dead_13, dead_14, ... \nmin values  :      0,       0,       0,       0,       0,       0, ... \nmax values  :      1,       1,       1,       1,       1,       1, ... \n```\n\n\n:::\n\n```{.r .cell-code}\nnlyr(fire_maps) # 27 layers, one for each fire\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 27\n```\n\n\n:::\n\n```{.r .cell-code}\nknitr::kable(head(values(fire_maps)))\n```\n\n::: {.cell-output-display}\n\n\n| dead_1| dead_10| dead_11| dead_12| dead_13| dead_14| dead_15| dead_16| dead_17| dead_18| dead_19| dead_2| dead_20| dead_21| dead_22| dead_23| dead_24| dead_25| dead_26| dead_27| dead_3| dead_4| dead_5| dead_6| dead_7| dead_8| dead_9|\n|------:|-------:|-------:|-------:|-------:|-------:|-------:|-------:|-------:|-------:|-------:|------:|-------:|-------:|-------:|-------:|-------:|-------:|-------:|-------:|------:|------:|------:|------:|------:|------:|------:|\n|      0|       0|       0|       0|       0|       0|       0|       0|       0|       0|       0|      0|       0|       0|       0|       0|       0|       0|       0|       0|      0|      0|      0|      0|      0|      0|      0|\n|      0|       0|       0|       0|       0|       0|       0|       0|       0|       0|       0|      0|       0|       0|       0|       0|       0|       0|       0|       0|      0|      0|      0|      0|      0|      0|      0|\n|      0|       0|       0|       0|       0|       0|       0|       0|       0|       0|       0|      0|       0|       0|       0|       0|       0|       0|       0|       0|      0|      0|      0|      0|      0|      0|      0|\n|      0|       0|       0|       0|       0|       0|       0|       0|       0|       0|       0|      0|       0|       0|       0|       0|       0|       0|       0|       0|      0|      0|      0|      0|      0|      0|      0|\n|      0|       0|       0|       0|       0|       0|       0|       0|       0|       0|       0|      0|       0|       0|       0|       0|       0|       0|       0|       0|      0|      0|      0|      0|      0|      0|      0|\n|      0|       0|       0|       0|       0|       0|       0|       0|       0|       0|       0|      0|       0|       0|       0|       0|       0|       0|       0|       0|      0|      0|      0|      0|      0|      0|      0|\n\n\n:::\n:::\n\n\nI can call on each of those 27 layers to examine the fire perimeters one by one. For example, this is the fire perimeter from the first fire in the simulation:\n\n\n::: {.cell .caption-margin}\n::: {.cell-output-display}\n![Fire Perimeter of first fire in spin-up simulation. The color gradient represents diedStemsFrac as a value from 0 to 1.](index_files/figure-html/fig-fireEx1-1.png){#fig-fireEx1 width=672}\n:::\n:::\n\n\nI'll use these rasters to determine which resource units experienced stand-replacing fire[^5], and use those resource unit IDs to filter the sapling and tree data.\n\n[^5]: Which I can now define more specifically as **diedStemFrac** = 1\n\n::: callout-note\nAn aside: this run is a spin-up simulation - I ran iLand, initializing forests from an empty landscape[^6] in year 0, and simulated forest growth and fire over 300 years. This seems to be the sweet spot for simulation runs - at year 300, it's a landscape full of a mix of mature, regenerating and recently burned stands, just as we'd observe in real life. Since fires that occur early in the spin-up inherently burn young stands, it's not terribly representative of the relationship between height and age in regrowth that I want to eventually compare to the herbivore-impacted relationship. So, I'll filter to just the last 100 years of the simulation.\n:::\n\n[^6]: An aside to the aside (meta!!) - it's an empty landscape in the sense that there are no trees in year 0, but I do initialize using a soil organic layer that varies heterogeneously across the landscape. This isn't just to represent real life for real life's sake - initializing from truly empty (truly bare ground) causes totally different patterns of forests. As has been shown in decades of work in Alaska by Jill Johnstone and others, soil organic layer filters forest community composition in really critical ways, allowing spruce to outcompete species like birch and aspen which can't persist in thick soil or moss layers for as long.\n\n::: callout-note\nQuestion: what determines the initial heterogeneity in the SOL when initiating from bare ground using the permafrost module? (technically it's the moss layer heterogeneity in year 0 that introduces the SOL heterogeneity in year 1 - where do those initial values come from?)\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  # filtering to last 100 years of fire\n  fire100 <- fire %>%\n    filter(year >200)\n  length(unique(fire100$fireId)) # How many fires in the last 100 years?\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 9\n```\n\n\n:::\n\n```{.r .cell-code}\n  # dropping layers from fire raster\n  fire_maps100 <- subset(fire_maps, \n                         paste0(\"dead_\", fire100$fireId))\n```\n:::\n\n\n# A quick (haha) aside: Reburns\n\n::: column-margin\nyou can take the girl out of the Reburn PhD, but you can't take the Reburn PhD out of the girl\n:::\n\nEven within the relatively narrow window of 100 years[^7], reburning occurs within the model! Here's the footprint of all fires in the last 100 years of the spin up - you can see there's some considerable overlap, or reburning.\n\n[^7]: what makes it narrow is the historic fire return interval for this system was somewhere between 100-300 years [@kelly2013]\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  # setting background to NA to make transparent\n  fire_mapsNA <- subst(fire_maps100, 0, NA) # need to do this anyways but now it'll let us stack\n  \n  plot(fire_mapsNA[[1]])\n  plot(fire_mapsNA[[2]], add = TRUE, legend = FALSE)\n  plot(fire_mapsNA[[3]], add = TRUE, legend = FALSE)\n  plot(fire_mapsNA[[4]], add = TRUE, legend = FALSE)\n  plot(fire_mapsNA[[5]], add = TRUE, legend = FALSE)\n  plot(fire_mapsNA[[6]], add = TRUE, legend = FALSE)\n  plot(fire_mapsNA[[7]], add = TRUE, legend = FALSE)\n  plot(fire_mapsNA[[8]], add = TRUE, legend = FALSE)\n  plot(fire_mapsNA[[9]], add = TRUE, legend = FALSE)\n```\n\n::: {.cell-output-display}\n![All fire perimeters from the last 100 years of the spin-up simulation.](index_files/figure-html/fig-fire_overlap-1.png){#fig-fire_overlap width=672}\n:::\n:::\n\n\n## Determining overlap between rasters using the *terra* package\n\nSince for this analysis I'm interested in the relationship between height and age, I'll need to filter out stands that burned shortly[^8] after preceding fires - a disturbance pattern which would definitely impact age-height relationships. I'll need to figure out where the overlaps actually occur, so I can exclude the corresponding resource units from the sapling and tree data later. I'll do this process in two ways: 1) by looking at the physical overlap between the entirety of the fire perimeters, 2) by looking only at the overlap between high severity fires.\n\n[^8]: Typically, \"short-interval\" fire in the boreal is defined as 50 years or less between fires [@buma2022]. Since I'm looking across a window of 100 years, I'm assuming everything that reburns in that 100 years is \"short-interval\" - I haven't looked to see if there's resource units that burn in year 1 and reburn in year 99, and maybe I'll do that down the line, but right now I don't want to bother.\n\nThe **intersect()** function in *terra* is useful for checking overlap, but only takes two rasters at a time:\n\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\noverlap <- terra::intersect(fire_mapsNA[[1]],\n                            fire_mapsNA[[2]])\n\nplot(overlap)\n```\n\n::: {.cell-output-display}\n![Overlap between first two fires](index_files/figure-html/fig-cap-margin-1.png){#fig-cap-margin width=672}\n:::\n:::\n\n\nTurns out, the best way I've found to quickly check which rasters overlap actually involves *terra*'s **mosaic()** function:\n\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\n# split all the layers into a list\nmapList <- terra::split(fire_mapsNA, 1:nlyr(fire_mapsNA))\n\n# turn list into SpatRaster Collection\nmapSPC <- terra::sprc(mapList) \n\n# merge values across layers\nreburn <- terra::mosaic(mapSPC, fun = \"sum\") # can apply a number of functions (mean, etc)\nplot(reburn)\n```\n\n::: {.cell-output-display}\n![Using mosaic() to collapse layers](index_files/figure-html/fig-mosaic-1.png){#fig-mosaic width=672}\n:::\n:::\n\n\nYay!! Okay!! Now, if I set all the values of the layers to 1, I'll end up with a raster of number of fires.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperim <- fire_maps100 > 0 # exclude unburned values\n\n# setting all values to 1 regardless of diedStemFrac\nperim <- subst(perim, TRUE, 1, others = NA) # everything else NA\n```\n:::\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\n# split all the layers into a list\nperimList <- terra::split(perim, 1:nlyr(perim))\n\n# turn list into SpatRaster Collection\nperimSPC <- terra::sprc(perimList) \n\n# merge values across layers\nnFire <- terra::mosaic(perimSPC, fun = \"sum\")\nplot(nFire)\n```\n\n::: {.cell-output-display}\n![Reburn history](index_files/figure-html/fig-reburnhist-1.png){#fig-reburnhist width=672}\n:::\n:::\n\n\nyay!! Now I can filter by the value of **nFire** to get the specific resource units that burned and eventually exclude them for the analysis.\n\n## iLand Reburn trends\n\nA few more exploratory tangential questions since we're here:\n\n##### How much of the landscape burned once?\n\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\nnfire1 <- subst(nFire, 1, 1, others = NA)\nplot(nfire1)\n```\n\n::: {.cell-output-display}\n![1x fire perimeters](index_files/figure-html/fig-1xperim-1.png){#fig-1xperim width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# what RID burned once?\nnfire1rid <- as.data.frame(mask(env.grid, nfire1))\n\n# how many unique resource units are there?\ndomain <- ncell(env.grid) # dimensions are 239 by 255 \n\n# how many resource units burned once?\nlength(unique(nfire1rid$env.grid)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 13300\n```\n\n\n:::\n\n```{.r .cell-code}\n# so, what %?\nround((length(unique(nfire1rid$env.grid)) / domain) *100, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 21.8\n```\n\n\n:::\n:::\n\n\n##### How much burned twice?\n\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\nnfire2 <- subst(nFire, 2, 1, others = NA)\nplot(nfire2)\n```\n\n::: {.cell-output-display}\n![2x fire perimeters](index_files/figure-html/fig-2xperim-1.png){#fig-2xperim width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# what RID burned twice?\nnfire2rid <- as.data.frame(mask(env.grid, nfire2))\n\n# so, what %?\nround((length(unique(nfire2rid$env.grid)) / domain) *100, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 3.8\n```\n\n\n:::\n:::\n\n\n##### How much burned three times?\n\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\nnfire3 <- subst(nFire, 3, 1, others = NA)\nplot(nfire3)\n```\n\n::: {.cell-output-display}\n![3x fire perimeters](index_files/figure-html/fig-3xperim-1.png){#fig-3xperim width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# what RID burned thrice?\nnfire3rid <- as.data.frame(mask(env.grid, nfire3))\n\n# so, what %?\nround((length(unique(nfire3rid$env.grid)) / domain) *100, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 8.2\n```\n\n\n:::\n:::\n\n\n### How does reburning in iLand compare to reburning in MTBS?\n\nHow does that compare to what we see in the real life frequency of reburning? As part of my work with reburns during my PhD, I worked on a paper with Brian Buma, Melissa Lucash and Shelby Weiss where we looked at trends in reburning across Alaska using the Monitoring Trends in Burn Severity database (MTBS) [@buma2022].\n\nA few important differences to cover up front:\n\n-   [MTBS](https://www.mtbs.gov/) data for Alaska covers 1984 to 2016 - so, the data captures a 32 year window instead of a 100 year one.\n-   We used a threshold of 2 to categorize MTBS maps of burn severity into \"burned\" and \"unburned\" classifications. I don't remember if we tested the sensitivity of our analysis to that threshold - I'm super curious how those percentages would change if we filtered to just the cells marked as high severity by MTBS.\n-   I don't remember off the top of my head how we dealt with Ecoregion / what Ecoregion CPCRW would fall into.\n\n\n::: {#tbl-MTBS-reburns .cell .tbl-cap-location-margin tbl-cap='Reburn Frequency of MTBS data from 1984 - 2016, across ecoregion (Buma et al. '}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Ecoregion </th>\n   <th style=\"text-align:right;\"> % Burned Total </th>\n   <th style=\"text-align:right;\"> % Burned Once </th>\n   <th style=\"text-align:right;\"> % Burned Twice </th>\n   <th style=\"text-align:right;\"> % Burned Thrice </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Interior forested lowlands/uplands </td>\n   <td style=\"text-align:right;\"> 18.7 </td>\n   <td style=\"text-align:right;\"> 95.5 </td>\n   <td style=\"text-align:right;\"> 4.3 </td>\n   <td style=\"text-align:right;\"> 0.10 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Yukon Flats </td>\n   <td style=\"text-align:right;\"> 29.5 </td>\n   <td style=\"text-align:right;\"> 95.5 </td>\n   <td style=\"text-align:right;\"> 4.4 </td>\n   <td style=\"text-align:right;\"> 0.10 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Interior bottomlands </td>\n   <td style=\"text-align:right;\"> 21.3 </td>\n   <td style=\"text-align:right;\"> 96.4 </td>\n   <td style=\"text-align:right;\"> 3.6 </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Interior highlands </td>\n   <td style=\"text-align:right;\"> 17.3 </td>\n   <td style=\"text-align:right;\"> 97.7 </td>\n   <td style=\"text-align:right;\"> 2.2 </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Ogilvie Mountains </td>\n   <td style=\"text-align:right;\"> 29.2 </td>\n   <td style=\"text-align:right;\"> 99.0 </td>\n   <td style=\"text-align:right;\"> 1.0 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Overall </td>\n   <td style=\"text-align:right;font-weight: bold;\"> 19.8 </td>\n   <td style=\"text-align:right;font-weight: bold;\"> 96.2 </td>\n   <td style=\"text-align:right;font-weight: bold;\"> 3.7 </td>\n   <td style=\"text-align:right;font-weight: bold;\"> 0.10 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nAgain, the reburn frequency in the 100 year interval of iLand is the following:\n\n\n::: {.cell}\n\n:::\n\n::: {#tbl-iLand-reburns .cell .tbl-cap-location-margin tbl-cap='iLand Reburn Frequency '}\n::: {.cell-output-display}\n\n\n|Ecoregion | % Burned Total| % Burned Once| % Burned Twice| % Burned Thrice|\n|:---------|--------------:|-------------:|--------------:|---------------:|\n|iLand     |           33.8|          21.8|            3.8|             8.2|\n\n\n:::\n:::\n\n\nSo, lower percentages than in the MTBS data.\n\nAn obviously incomplete spitball list of reasons reburning could be lower in iLand:\n\n-   **iLand is super stochastic?** - runs vary from simulation to simulation. I can try replicating this simulation a few hundred times and averaging fire frequency across them all to see if the distribution of reburning becomes more similar to what we observe in MTBS\n\n-   **Uncertainty in MTBS?**\n\n-   **Mechanisms that drive fire in iLand underestimate reburning?**\n\n## What about fire severity?\n\nNow, I can introduce one more layer: in theory, we[^9] often expect reburns (or fires that burn into existing fire perimeters) to occur at diminishing severity. Depending on the window between fires, fuel availability may limit combustion in reburns. Based on that logic, are there overlaps between stands that burned at high severity?\n\n[^9]: we, the royal fire ecologists\n\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\n# filter to just stands with high severity\n  # cells with diedStemsFrac = 1\n  fire_mapsHS <- subst(fire_maps100, 1, 1, others = NA)\n  \n  plot(fire_mapsHS[[1]])\n  plot(fire_mapsHS[[2]], add = TRUE, legend = FALSE)\n  plot(fire_mapsHS[[3]], add = TRUE, legend = FALSE)\n  plot(fire_mapsHS[[4]], add = TRUE, legend = FALSE)\n  plot(fire_mapsHS[[5]], add = TRUE, legend = FALSE)\n  plot(fire_mapsHS[[6]], add = TRUE, legend = FALSE)\n  plot(fire_mapsHS[[7]], add = TRUE, legend = FALSE)\n  plot(fire_mapsHS[[8]], add = TRUE, legend = FALSE)\n  plot(fire_mapsHS[[9]], add = TRUE, legend = FALSE)\n```\n\n::: {.cell-output-display}\n![High severity fires](index_files/figure-html/fig-HS-1.png){#fig-HS width=672}\n:::\n:::\n\n\nObviously less area there. Is there any overlap?\n\n\n::: {.cell fig-cap-location='margin'}\n\n```{.r .cell-code}\n# split all the layers into a list\nhsList <- terra::split(fire_mapsHS, 1:nlyr(fire_mapsHS))\n\n# turn list into SpatRaster Collection\nhsSPC <- terra::sprc(hsList) \n\n# merge values across layers\nnFireHS <- terra::mosaic(hsSPC, fun = \"sum\")\nplot(nFireHS)\n```\n\n::: {.cell-output-display}\n![Times each resource unit has burned at high severity](index_files/figure-html/fig-reburnHS-count-1.png){#fig-reburnHS-count width=672}\n:::\n:::\n\n\nOkay. Pretty sparse, but technically there's still resource units that burned completely both times.\n\n\n::: {.cell fig-cap-location='margin'}\n\n```{.r .cell-code}\nnfireHS2 <- subst(nFireHS, 2, 1, others = NA)\nplot(nfireHS2)\n```\n\n::: {.cell-output-display}\n![Resource Units that burned twice, each time high severity](index_files/figure-html/fig-reburnHS1-1.png){#fig-reburnHS1 width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# what RID burned twice at HS?\nnfireHS2rid <- as.data.frame(mask(env.grid, nfireHS2))\n\n# how many resource units?\nlength(unique(nfireHS2rid$env.grid))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 8\n```\n\n\n:::\n\n```{.r .cell-code}\n# so, what %?\n(length(unique(nfireHS2rid$env.grid)) / domain) *100\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.01312659\n```\n\n\n:::\n:::\n\n\nI'm curious about the years that burned twice at high severity. What's the interval between them?\n\nTo get back to years, I'll have to use the list of RIDs to find *fireID* in the **fire_maps** object, and then use *fireID* to look in the original fire output from iLand. Essentially, retracing our steps. I'll start by converting the object containing resource units that burned twice at high severity (**nfireHS2**) back to a polygon, so I can use *terra*'s **extract()** function to pull information from fire_maps.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnfireHS2poly <- terra::as.polygons(nfireHS2)\nplot(nfireHS2poly)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/interval between HS reburn-1.png){width=672}\n:::\n\n```{.r .cell-code}\nfire_mapsHS2 <- terra::extract(fire_maps100, nfireHS2poly)\nhead(fire_mapsHS2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  ID dead_19 dead_20 dead_21   dead_22 dead_23 dead_24 dead_25 dead_26 dead_27\n1  1       0       0       0 0.9005525       0       1       0       1       0\n2  1       0       0       0 0.8333333       0       1       0       1       0\n3  1       0       0       0 0.8809524       0       1       0       1       0\n4  1       0       0       0 0.9444444       0       1       0       1       0\n5  1       0       0       0 0.8918919       0       1       0       1       0\n6  1       0       0       0 0.9545454       0       1       0       1       0\n```\n\n\n:::\n\n```{.r .cell-code}\n# drop ID column\nfire_mapsHS2 <- fire_mapsHS2 %>%\n  select(!ID) %>%\n  select(where(~ any(. != 0)))\n\nknitr::kable(fire_mapsHS2)\n```\n\n::: {.cell-output-display}\n\n\n|   dead_22| dead_24| dead_26|\n|---------:|-------:|-------:|\n| 0.9005525|       1|       1|\n| 0.8333333|       1|       1|\n| 0.8809524|       1|       1|\n| 0.9444444|       1|       1|\n| 0.8918919|       1|       1|\n| 0.9545454|       1|       1|\n| 0.0000000|       1|       1|\n| 0.0000000|       1|       1|\n\n\n:::\n\n```{.r .cell-code}\n# 18 reburned 19\n# 18 reburned 20\n# 23 reburned 27\n# 25 reburned 27\n\nfireHS2 <-  fire %>%\n  select(c(year, fireId)) %>%\n  filter(fireId %in% as.numeric(str_sub(colnames(fire_mapsHS2), -2))) \n\nfireHS2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 2\n   year fireId\n  <int>  <int>\n1   229     22\n2   273     24\n3   290     26\n```\n\n\n:::\n:::\n\n\nNow, I want to use the row id numbers from the **fire_mapsHS** object to filter out rows in the **sapling** and **stand** output that burned at high severity. The following code loops through each of the fire maps, extracting the resource unit ID numbers, the fire ID and the fire year (which come from the default fire output) and compiling into a dataframe, **fireID**. What fraction of the landscape burned at high severity? (ie, how many resource units?)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfireID <- data.frame()\n\nfor (i in 1:nrow(fire100)) {\n  \n  # Skip fires that burned nothing\n  if (fire100$area_m2[i] > 0) {\n  \n    mask <- fire_mapsHS[[paste0(\"dead_\", fire100$fireId[i])]]\n    \n    # Use the mask to extract the rids for burned grids\n    burned_rids <- as.data.frame(mask(env.grid, mask))\n    burned_rids= burned_rids%>%filter(!is.na(env.grid))\n    burned_rids$year=fire100$year[i]\n    burned_rids$fireID = fire100$fireId[i]\n  }\n  \n  fireID = rbind(fireID, burned_rids)\n}\n\nfireID = fireID %>% rename(\"rid\" = env.grid, \"fire.year\" = year)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# how many unique resource units are there?\ndomain <- ncell(env.grid) # dimensions are 239 by 255 \n\n# how many resource units burned at HS?\nlength(unique(fireID$rid)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 622\n```\n\n\n:::\n\n```{.r .cell-code}\n# so, what %?\n(length(unique(fireID$rid)) / domain) *100\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.020592\n```\n\n\n:::\n:::\n\n\nSo, only about 1% of the landscape burned at high severity across the 100 year simulation window. (Though, technically that would be an underestimate since it doesn't take into account the resource units that reburned).\n\n# Session Info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.3.3 (2024-02-29)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Sonoma 14.0\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: America/Chicago\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] kableExtra_1.4.0 cowplot_1.1.3    terra_1.7-55     lubridate_1.9.3 \n [5] forcats_1.0.0    stringr_1.5.1    dplyr_1.1.4      purrr_1.0.2     \n [9] readr_2.1.5      tidyr_1.3.1      tibble_3.2.1     ggplot2_3.5.0   \n[13] tidyverse_2.0.0 \n\nloaded via a namespace (and not attached):\n [1] utf8_1.2.4        generics_0.1.3    xml2_1.3.6        stringi_1.8.3    \n [5] hms_1.1.3         digest_0.6.35     magrittr_2.0.3    evaluate_0.23    \n [9] grid_4.3.3        timechange_0.3.0  fastmap_1.1.1     jsonlite_1.8.8   \n[13] fansi_1.0.6       viridisLite_0.4.2 scales_1.3.0      codetools_0.2-19 \n[17] cli_3.6.2         rlang_1.1.3       munsell_0.5.0     withr_3.0.0      \n[21] yaml_2.3.8        tools_4.3.3       tzdb_0.4.0        colorspace_2.1-0 \n[25] vctrs_0.6.5       R6_2.5.1          lifecycle_1.0.4   htmlwidgets_1.6.4\n[29] pkgconfig_2.0.3   pillar_1.9.0      gtable_0.3.4      glue_1.7.0       \n[33] Rcpp_1.0.12       systemfonts_1.0.6 highr_0.10        xfun_0.43        \n[37] tidyselect_1.2.1  rstudioapi_0.16.0 knitr_1.45        htmltools_0.5.8  \n[41] rmarkdown_2.26    svglite_2.1.3     compiler_4.3.3   \n```\n\n\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}